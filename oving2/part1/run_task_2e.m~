clear all;
clc;
close all;
autopilot_constants;

d = 0;

s = tf('s');
H_phi_open = minreal(a_phi_2*(k_p_phi*s + k_i_phi) / (s^2*(s + a_phi_1 + a_phi_2*k_d_phi)));
H_phi_closed = H_phi_open/(1+H_phi_open);
H_chi_open = minreal(g/(V_g*s)*(H_phi_closed)*(k_i_chi/s+k_p_chi));
H_chi_closed = H_chi_open/(1+H_chi_open);
%{
S = 500;
t = 0:1:S-1;
reference = zeros(1, S);
step_val = 0;
k = 0;
for i = 1:S,
    if i == 100
        step_val = 2;
    elseif i == 200
        step_val = 5;
    elseif i == 300
        step_val = 10;
    elseif i == 400
        step_val = 20;
         
    end
    reference(i) = step_val;
end

figure(1)
lsim(H_chi_closed,reference',t)

%}
ref_steps = [0 2  20]*deg2rad; %steps in reference. 
sim_time = 100;
prev_simulated_time = 0;
figure(1)


for chi_c = ref_steps,
    load_system('autopilot.slx');
    sim('autopilot.slx');
   
    plot(prev_simulated_time + chi.time,chi.signals.values.*rad2deg); hold on; 
    prev_simulated_time = prev_simulated_time + sim_time;

end
