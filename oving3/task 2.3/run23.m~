%% Information 
% This file is only an example of how you can start the simulation. The
% sampling time decides how often you store states. The execution  time
% will increase if you reduce the sampling time.

% Please note that the file "pathplotter.m" (only used in the second part
% of the assignment) shows the ship path during the path following and
% target tracking part of the assignment. It can be clever to adjust the sampling
% time when you use that file because it draws a sketch of the ship in the
% North-East plane at each time instant. Having a small sampling time will
% lead to a lot over overlap in the ship drawing. 

% You should base all of your simulink models on the MSFartoystyring model
% and extend that as you solve the assignment. For your own sake, it is
% wise to create a new model and run file for each task. That is
% especially important in the problems you need to hand in since the files
% you deliver only should create the desired result in that task.

% The msfartoystyring.m file includes the ship model. You are not allowed
% to change anything within that file. You need to include that file in
% every folder where you have a simulink model based on
% "MSFartoystyring.slx". 

% WP.mat is a set of six waypoints that you need to use in the second part of
% the assignment. The north position is given in the first row and the east
% position in the second row. 

clear all
clc
close all


%%

rad2deg = 180/pi;
deg2rad = pi/180;

tstart=0;           % Sim start time
tstop=5000;        % Sim stop time
tsamp=10;           % Sampling time for how often states are stored. (NOT ODE solver time step)
                
p0=zeros(2,1);      % Initial position (NED)
v0=[6.63 0]';       % Initial velocity (body)
psi0=0;             % Inital yaw angle
r0=0;               % Inital yaw rate
c=0;                % Current on (1)/off (0)


init_controllers

%% task 2.1


%Loading waypoints
load('WP.mat')

wpt_posx = WP(1,:);
wpt_posy = WP(2,:);
wpt_time = [0 20 40 60 80 100]; 
t = 0:1:max(wpt_time);

% method 1 - cubic Hermite interpolation
x_p = pchip(wpt_time,wpt_posx,t);
y_p = pchip(wpt_time,wpt_posy,t);

% method 2 - spline interpolation
x_s = spline(wpt_time,wpt_posx,t); 
y_s = spline(wpt_time,wpt_posy,t);

%plotting method 1 vs method 2
figure()
subplot(311), plot(wpt_time,wpt_posx,'o',t,[x_p; x_s])
legend ('waypoint-x position', 'hermite-x position', 'spine-x position');
xlabel('time (s)')
ylabel('x- position (m)')
subplot(312), plot(wpt_time,wpt_posy,'o',t,[y_p; y_s])
legend ('waypoint-y position', 'hermite-y position', 'spine-y position');
xlabel('time (s)')
ylabel('y- position (m)')
subplot(313), plot(wpt_posy,wpt_posx,'o',y_p,x_p,y_s,x_s)
legend ('position', 'hermite position', 'spine position');
xlabel('y- position (m)')
ylabel('x- position (m)')

% method 3 - Dubins path

%Need to find maximum turning radius
sim MSFartoystyringtask21
pathplotter(p(:,1),p(:,2),psi,tsamp,100,tstart,tstop,0,zeros(2))
title('Path with maximum rudder and velocity to find turning radius')
turningRadius = 365; %m
n_of_waypoints = length(WP(1, :));
R_bar = zeros(1, n_of_waypoints-2);
%line(wpt_posx,wpt_posy)
for i = 1:n_of_waypoints-2
    A = WP(:,i+2)- WP(:,i);
    B = WP(:,i+1)  - WP(:,i);
    C = WP(:,i+2)- WP(:,i+1)  ;
    
    a = norm(A);
    b = norm(B);
    c = norm(C);

    %cosinus-rule
    alpha = 0.5 * acos((b^2+c^2-a^2)/(2*b*c));
  
    R_bar(i) = turningRadius * tan(alpha);
    
    current_wp = WP(:,i);
    next_wp = WP(:,i+1);
    
    beta = asin(next_wp(1)-current_wp(1)/c);
    center_dist = sqrt(R_bar(i)^2+turningRadius^2);
    delta_x
    
    WP_c_s(:,i) = WP(:,i+1) - B/norm(B) * turningRadius;
    angle = atan2(C(2),C(1)) - atan2(B(2),B(1));
    r_center(:,i) = WP_c_s(:,i) + sign(angle) * ((B/norm(B))'*[0 1;-1 0])'*R_bar(i);
    
    viscircles(r_center(:,i)', R_bar(i), 'LineWidth', 1);
    %viscircles(r_center(:,i), R_bar(i), 'LineWidth', 1);
    hold on;
end


figure()
plot(p(:,1),p(:,2));
legend({'$u_{tilde}$'}, 'Interpreter','latex')
xlabel('time (s)')
ylabel('speed error [m/s]')
title('Closed loop behaviour of $u_{tilde}$','Interpreter','latex','FontSize',16)
